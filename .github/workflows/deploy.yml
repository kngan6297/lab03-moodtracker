name: Deploy to VPS

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: mood-tracker-jar
          path: artifacts/

      - name: Download config files
        uses: actions/download-artifact@v4
        with:
          name: config-files
          path: config/

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            # Create deployment directory
            mkdir -p /var/www/moodtracker-deploy

            # Stop existing application
            pkill -f mood-tracker || true

            # Wait a moment for process to stop
            sleep 5

            # Backup existing application
            if [ -d "/var/www/lab03-moodtracker" ]; then
              cp -r /var/www/lab03-moodtracker /var/www/lab03-moodtracker.backup.$(date +%Y%m%d_%H%M%S)
            fi

            # Update application files
            cd /var/www/lab03-moodtracker

            # Copy new JAR file
            cp /tmp/artifacts/mood-tracker-0.0.1-SNAPSHOT.jar target/

            # Update configuration files
            cp /tmp/config/application-prod.properties src/main/resources/
            cp /tmp/config/application.properties src/main/resources/

            # Set proper permissions
            chmod +x target/mood-tracker-0.0.1-SNAPSHOT.jar

            # Start application
            nohup java -jar target/mood-tracker-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod > moodtracker.log 2>&1 &

            # Wait for application to start
            sleep 10

            # Check if application is running
            if pgrep -f mood-tracker > /dev/null; then
              echo "✅ Application deployed successfully!"
              echo "🌐 Access at: http://${{ secrets.VPS_HOST }}:8080"
            else
              echo "❌ Application failed to start"
              tail -20 moodtracker.log
              exit 1
            fi
